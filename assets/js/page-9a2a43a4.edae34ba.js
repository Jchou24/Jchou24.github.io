(window.webpackJsonp=window.webpackJsonp||[]).push([[68],{1123:function(t,s,a){"use strict";a.r(s);var r=a(22),v=Object(r.a)({},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("p",[t._v("程式中之例外處理是門大學問，有時他可能微不足道，有時他也可以毀了一個應用")]),t._v(" "),a("p",[t._v("剛好這幾天去上了Teddy的例外處理，這邊就記錄一下當時上課的想法")]),t._v(" "),a("h1",{attrs:{id:"design-by-contract"}},[t._v("Design By Contract")]),t._v(" "),a("p",[t._v("一種開發思維，不精確來說，可以當作是在做初始值的檢查，並且把他變成是一種機制")]),t._v(" "),a("p",[t._v("畢竟許多 exception 的發生，其實都跟不正確的初始值有關")]),t._v(" "),a("p",[t._v("我在知乎看到了一個python範例我覺得滿淺顯易懂的"),a("sup",{staticClass:"footnote-ref"},[a("a",{attrs:{href:"#fn1",id:"fnref1"}},[t._v("[1]")])])]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("calc_BMI")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mass"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("float")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" height"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("float")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("float")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[t._v('"""\nCalculate BMI indicator value.\n"""')]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Contracts")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("assert")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" mass    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Mass should not be smaller than 20[kg]. '")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("assert")]),t._v(" mass "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("300")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Mass should not be larger than 300[kg]. '")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("assert")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.7")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" height "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Height should not be smaller than 0.7[m]. '")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("assert")]),t._v(" height "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.8")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Height should not be larger than 2.8[m]. '")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Body")]),t._v("\nres "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" mass "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" height"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("**")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" res\n")])])]),a("h1",{attrs:{id:"root-cause-根本原因"}},[t._v("Root Cause(根本原因)")]),t._v(" "),a("p",[t._v("有的時候一個exception的發生式來源於前面code的邏輯出錯")]),t._v(" "),a("p",[t._v("比方說到DB拿值，結果拿到null，但預期應該要是空陣列，這時執行foreach的code就會壞的莫名其妙，不好找到出錯源頭")]),t._v(" "),a("h1",{attrs:{id:"robustness-強建度"}},[t._v("Robustness(強建度)")]),t._v(" "),a("p",[t._v("可以簡單類比成系統的例外處理做的好不好，做的好，系統不容易掛掉，當然就是比較穩健的系統")]),t._v(" "),a("p",[t._v("但要開發這樣的系統，成本就會非常高昂")]),t._v(" "),a("p",[t._v("很多時候，開需求的人都總會覺得系統這樣那樣不應該壞掉，但給的開發時程又不是很充足")]),t._v(" "),a("p",[t._v("如何跟開需求的人闡明 "),a("code",[t._v("robustness")]),t._v(" 與 "),a("code",[t._v("開發成本")]),t._v(" 真的是個大問題")]),t._v(" "),a("h1",{attrs:{id:"fault-x-error-x-failure"}},[t._v("Fault x Error x Failure")]),t._v(" "),a("p",[t._v("有的人將例外分成了3種等級，簡單來說，有點連鎖效應的感覺")]),t._v(" "),a("p",[t._v("前者可會導致後者的發生，像是fault發生可能導致error也發生，error發生可能導致failure發生")]),t._v(" "),a("p",[t._v("而 failure 是最危險的，因為他可能會導致服務偏離規格")]),t._v(" "),a("p",[t._v("所以若要在強健度與開發時程取個平衡點的話，或許可以盡量把exception的發生控制在低一點的層級")]),t._v(" "),a("p",[t._v("有時間再盡可能的去修掉可能發生exception的code")]),t._v(" "),a("h1",{attrs:{id:"發生來源"}},[t._v("發生來源")]),t._v(" "),a("p",[t._v("其實這也是一個看待exception的角度，exception的發生要不是自己造成的，不然就是別人造成的")]),t._v(" "),a("p",[t._v("若是自己造成的，控制權在自己手上，那當然就是自己能有多點的處理空間")]),t._v(" "),a("p",[t._v("若是別人造成的，控制權在別人手上，有時就要祈禱對方願意改了，但若別人有歷史包袱，或兼容問題")]),t._v(" "),a("p",[t._v("那狀況就比較麻煩了，可能就得由自己這邊多做些處理了")]),t._v(" "),a("h1",{attrs:{id:"fault-tolerant-高容錯"}},[t._v("Fault-Tolerant(高容錯)")]),t._v(" "),a("p",[t._v("簡單來說，就是系統一部分壞掉了，整體還是可以正常運行")]),t._v(" "),a("p",[t._v("像是微服務化的系統，可以利用像是k8s之類的技術，動態調整服務")]),t._v(" "),a("h1",{attrs:{id:"asynchronous-exception"}},[t._v("Asynchronous Exception")]),t._v(" "),a("p",[t._v("這類型的exception還滿有趣的，像是runtime的時候遇到記憶體不足")]),t._v(" "),a("p",[t._v("這類由系統主動通知的，通常都是Asynchronous Exception")]),t._v(" "),a("p",[t._v("也就是說，這類Exception能不遇到就不要遇到，不然一發生似乎都是滿大條的 lol")]),t._v(" "),a("h1",{attrs:{id:"try-catch-finally"}},[t._v("Try-Catch-Finally")]),t._v(" "),a("p",[t._v("大多數程式語言都會有try-catch-finally這樣的語法可以用")]),t._v(" "),a("p",[t._v("一般來說，大概會是這樣使用")]),t._v(" "),a("table",[a("thead",[a("tr")]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("try")]),t._v(" "),a("td",[t._v("主要要執行的邏輯")])]),t._v(" "),a("tr",[a("td",[t._v("catch")]),t._v(" "),a("td",[t._v("有例外時要做的事")])]),t._v(" "),a("tr",[a("td",[t._v("finally")]),t._v(" "),a("td",[t._v("最終要做的事")])])])]),t._v(" "),a("p",[t._v("而具體來說，我大概是會這樣使用")]),t._v(" "),a("table",[a("thead",[a("tr")]),t._v(" "),a("tbody",[a("tr",[a("td",{attrs:{rowspan:"2"}},[t._v("try")]),t._v(" "),a("td",[t._v("主要要執行的邏輯")])]),t._v(" "),a("tr",[a("td",[t._v("log訊息")])]),t._v(" "),a("tr",[a("td",{attrs:{rowspan:"3"}},[t._v("catch")]),t._v(" "),a("td",[t._v("嘗試錯誤修復")])]),t._v(" "),a("tr",[a("td",[t._v("將對外訊息整理得更具可讀性")])]),t._v(" "),a("tr",[a("td",[t._v("log訊息")])]),t._v(" "),a("tr",[a("td",{attrs:{rowspan:"4"}},[t._v("finally")]),t._v(" "),a("td",[t._v("最終要做的事")])]),t._v(" "),a("tr",[a("td",[t._v("關掉connection")])]),t._v(" "),a("tr",[a("td",[t._v("記憶體釋放")])]),t._v(" "),a("tr",[a("td",[t._v("log訊息")])])])]),t._v(" "),a("p",[t._v("而在上課時，我覺得投影片上的定義寫的滿不錯的")]),t._v(" "),a("table",[a("thead",[a("tr")]),t._v(" "),a("tbody",[a("tr",[a("td",{attrs:{rowspan:"3"}},[t._v("try")]),t._v(" "),a("td",[t._v("implement requirements(can have alternatives)")])]),t._v(" "),a("tr",[a("td",[t._v("prepare state recovery (ex make a check point)")])]),t._v(" "),a("tr",[a("td",[t._v("report exceptional conditions")])]),t._v(" "),a("tr",[a("td",{attrs:{rowspan:"3"}},[t._v("catch")]),t._v(" "),a("td",[t._v("perform error and fault handling")])]),t._v(" "),a("tr",[a("td",[t._v("report exceptional conditions")])]),t._v(" "),a("tr",[a("td",[t._v("control retry flow")])]),t._v(" "),a("tr",[a("td",{attrs:{rowspan:"2"}},[t._v("finally")]),t._v(" "),a("td",[t._v("release resources")])]),t._v(" "),a("tr",[a("td",[t._v("drop check points if any")])])])]),t._v(" "),a("h2",{attrs:{id:"關於log"}},[t._v("關於log")]),t._v(" "),a("p",[t._v("最好不要每個try catch都寫log，否則一樣的訊息可能會被重複log好多次")]),t._v(" "),a("p",[t._v('一種解法是做個"保護傘"，在最外層進行log，這樣就能確保只會log一次')]),t._v(" "),a("h1",{attrs:{id:"error-handling"}},[t._v("Error Handling")]),t._v(" "),a("p",[t._v("error其實就已經有點可怕了，畢竟可能會造成Failure")]),t._v(" "),a("p",[t._v("而針對這種情形，復原(Backward recovery)或許是種好的應對策略")]),t._v(" "),a("p",[t._v("具體做法大致可分為兩類")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("State-based: 像是製作映像檔")])]),t._v(" "),a("li",[a("p",[t._v("Operation-based: 像是使用Undo，可以一個指令一個指令回復")])])]),t._v(" "),a("h1",{attrs:{id:"行為回復的實作策略"}},[t._v("行為回復的實作策略")]),t._v(" "),a("h2",{attrs:{id:"fault-handling"}},[t._v("Fault Handling")]),t._v(" "),a("ul",[a("li",[t._v("診斷 diagnosis")]),t._v(" "),a("li",[t._v("隔離 isolation")]),t._v(" "),a("li",[t._v("重新組態 reconfiguration")]),t._v(" "),a("li",[t._v("重新初始化 reinitialization")])]),t._v(" "),a("h2",{attrs:{id:"retry"}},[t._v("Retry")]),t._v(" "),a("ul",[a("li",[t._v("設計多樣性( design diversity )")]),t._v(" "),a("li",[t._v("功能多樣性( functional diversity )\n"),a("ul",[a("li",[t._v("像是不同的登入方式")]),t._v(" "),a("li",[t._v("FB登入、Google登入")])])]),t._v(" "),a("li",[t._v("資料多樣性( data diversity )\n"),a("ul",[a("li",[t._v("像是exception後給default data")])])]),t._v(" "),a("li",[t._v("時序多樣性( temporal diversity )\n"),a("ul",[a("li",[t._v("隔一段時間再retry，像是網路瞬斷")])])])]),t._v(" "),a("hr"),t._v(" "),a("p",[t._v("Exception 很多是不可預期的，無法靠事先if else去做檢查")]),t._v(" "),a("p",[t._v("當然能事先預判也是不錯的，畢竟Exception的產生，其實也是會耗掉系統效能的")]),t._v(" "),a("p",[t._v("其實我覺得這也引導出了一個問題: "),a("code",[t._v("什麼是好的軟體？")])]),t._v(" "),a("p",[t._v("這其實在課堂上大家也有不少的討論，而有幾個方像我覺得滿不錯的")]),t._v(" "),a("pre",[a("code",[t._v("好不好加功能?\n")])]),t._v(" "),a("p",[t._v("畢竟，不好加功能的話，那就跟硬體好像沒什麼區別了")]),t._v(" "),a("pre",[a("code",[t._v("調整跟scope有關跟時間比較無關\n")])]),t._v(" "),a("p",[t._v("基本上來說，就是希望開發的時程是可預期的，加幾個功能大概需要花多少時間")]),t._v(" "),a("p",[t._v("如果是架構很雜亂的系統，這件事一定很難達到")]),t._v(" "),a("p",[t._v("甚至加一個功能搞不好還會影響到以前的功能")]),t._v(" "),a("hr",{staticClass:"footnotes-sep"}),t._v(" "),a("section",{staticClass:"footnotes"},[a("ol",{staticClass:"footnotes-list"},[a("li",{staticClass:"footnote-item",attrs:{id:"fn1"}},[a("p",[a("a",{attrs:{href:"https://www.zhihu.com/question/19864652/answer/71204977",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://www.zhihu.com/question/19864652/answer/71204977"),a("OutboundLink")],1),t._v(" "),a("a",{staticClass:"footnote-backref",attrs:{href:"#fnref1"}},[t._v("↩︎")])])])])])])},[],!1,null,null,null);s.default=v.exports}}]);
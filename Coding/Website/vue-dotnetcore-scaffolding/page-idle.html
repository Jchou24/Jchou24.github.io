<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue3 + .Net Core3 SPA + Page Idle | VueJCBlog</title>
    <meta name="description" content="A Blog made by Vuepress">
    <link rel="icon" href="/icon.png">
  <link rel="manifest" href="/manifest.webmanifest">
    <meta property="og:site_name" content="VueJCBlog"><meta property="og:title" content="Vue3 + .Net Core3 SPA + Page Idle"><meta property="og:type" content="website"><meta property="og:url" content="/Coding/Website/vue-dotnetcore-scaffolding/page-idle.html"><meta name="twitter:title" content="Vue3 + .Net Core3 SPA + Page Idle"><meta name="twitter:url" content="/Coding/Website/vue-dotnetcore-scaffolding/page-idle.html"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:label1" content="Written by"><meta name="twitter:label2" content="Filed under"><meta name="twitter:data2" content="閒置, idledeterminestates, 登出, 時間, 進行, localstorage, 網頁, 分頁, js, install, user, npm, store, 倒數, 狀態, pageidle, state, 警告, 機制, 一個, runtimer1, date, 觸發, throttle, timer1, 時間點, 1000, new, vuex, 10"><meta property="article:tag" content="閒置"><meta property="article:tag" content="idledeterminestates"><meta property="article:tag" content="登出"><meta property="article:tag" content="時間"><meta property="article:tag" content="進行"><meta property="article:tag" content="localstorage"><meta property="article:tag" content="網頁"><meta property="article:tag" content="分頁"><meta property="article:tag" content="js"><meta property="article:tag" content="install"><meta property="article:tag" content="user"><meta property="article:tag" content="npm"><meta property="article:tag" content="store"><meta property="article:tag" content="倒數"><meta property="article:tag" content="狀態"><meta property="article:tag" content="pageidle"><meta property="article:tag" content="state"><meta property="article:tag" content="警告"><meta property="article:tag" content="機制"><meta property="article:tag" content="一個"><meta property="article:tag" content="runtimer1"><meta property="article:tag" content="date"><meta property="article:tag" content="觸發"><meta property="article:tag" content="throttle"><meta property="article:tag" content="timer1"><meta property="article:tag" content="時間點"><meta property="article:tag" content="1000"><meta property="article:tag" content="new"><meta property="article:tag" content="vuex"><meta property="article:tag" content="10">
    <link rel="preload" href="/assets/css/0.styles.9984fa41.css" as="style"><link rel="preload" href="/assets/js/app.c7870012.js" as="script"><link rel="preload" href="/assets/js/layout-Layout.29445450.js" as="script"><link rel="preload" href="/assets/js/page-11a8df82.4cea3682.js" as="script"><link rel="prefetch" href="/assets/js/1.666c7553.js"><link rel="prefetch" href="/assets/js/116.04edb76b.js"><link rel="prefetch" href="/assets/js/117.ac275b69.js"><link rel="prefetch" href="/assets/js/118.ff18e79b.js"><link rel="prefetch" href="/assets/js/119.c856bbc7.js"><link rel="prefetch" href="/assets/js/120.9c35d03e.js"><link rel="prefetch" href="/assets/js/121.4c5a24a0.js"><link rel="prefetch" href="/assets/js/122.6f26c9b4.js"><link rel="prefetch" href="/assets/js/123.31b79da2.js"><link rel="prefetch" href="/assets/js/124.cf0261c9.js"><link rel="prefetch" href="/assets/js/125.69c7d910.js"><link rel="prefetch" href="/assets/js/126.32d079e6.js"><link rel="prefetch" href="/assets/js/127.837a3a82.js"><link rel="prefetch" href="/assets/js/128.b1694b54.js"><link rel="prefetch" href="/assets/js/129.8465e37c.js"><link rel="prefetch" href="/assets/js/130.9ac035fa.js"><link rel="prefetch" href="/assets/js/131.fd3bd900.js"><link rel="prefetch" href="/assets/js/132.6f6776e8.js"><link rel="prefetch" href="/assets/js/133.9716d0e0.js"><link rel="prefetch" href="/assets/js/134.6d4c14ab.js"><link rel="prefetch" href="/assets/js/135.ee7b8cd2.js"><link rel="prefetch" href="/assets/js/136.cd9a8afb.js"><link rel="prefetch" href="/assets/js/137.b4e66c79.js"><link rel="prefetch" href="/assets/js/138.f82ac177.js"><link rel="prefetch" href="/assets/js/139.9ad3847d.js"><link rel="prefetch" href="/assets/js/140.664c056a.js"><link rel="prefetch" href="/assets/js/2.b335b60d.js"><link rel="prefetch" href="/assets/js/3.f5362870.js"><link rel="prefetch" href="/assets/js/4.92687a32.js"><link rel="prefetch" href="/assets/js/5.f132b447.js"><link rel="prefetch" href="/assets/js/6.234d5839.js"><link rel="prefetch" href="/assets/js/layout-BaseLayout.37ed891a.js"><link rel="prefetch" href="/assets/js/layout-NotFound.351563b2.js"><link rel="prefetch" href="/assets/js/page-0193e625.cbe0c876.js"><link rel="prefetch" href="/assets/js/page-021b3aa4.9b00c44b.js"><link rel="prefetch" href="/assets/js/page-0a921c99.cccbfc74.js"><link rel="prefetch" href="/assets/js/page-0c6c4d65.5c8e3650.js"><link rel="prefetch" href="/assets/js/page-0c7f77bc.69a91bf3.js"><link rel="prefetch" href="/assets/js/page-0d32e5ee.4073d4ab.js"><link rel="prefetch" href="/assets/js/page-0e69d9d2.17047452.js"><link rel="prefetch" href="/assets/js/page-1080dbe2.3c97bc00.js"><link rel="prefetch" href="/assets/js/page-1486eb54.958c3954.js"><link rel="prefetch" href="/assets/js/page-177d640c.72680242.js"><link rel="prefetch" href="/assets/js/page-1a34eb5d.fc52abac.js"><link rel="prefetch" href="/assets/js/page-1c4a4e12.385c1707.js"><link rel="prefetch" href="/assets/js/page-1ccc22d8.f18fb3c5.js"><link rel="prefetch" href="/assets/js/page-1db42de8.1b9883d3.js"><link rel="prefetch" href="/assets/js/page-1e536af9.bf024de0.js"><link rel="prefetch" href="/assets/js/page-21fcb945.ec0399d3.js"><link rel="prefetch" href="/assets/js/page-25bc4f18.b58fbbb8.js"><link rel="prefetch" href="/assets/js/page-27f6ecec.04d3fd50.js"><link rel="prefetch" href="/assets/js/page-29c918e5.b244c75e.js"><link rel="prefetch" href="/assets/js/page-2c6bc4ab.7a9acfdd.js"><link rel="prefetch" href="/assets/js/page-2e8c0cd0.5980fb01.js"><link rel="prefetch" href="/assets/js/page-302e6251.28c13f5d.js"><link rel="prefetch" href="/assets/js/page-320aac86.bf2cf2b8.js"><link rel="prefetch" href="/assets/js/page-339369e0.497f9705.js"><link rel="prefetch" href="/assets/js/page-36d5d2b3.7bba3fcf.js"><link rel="prefetch" href="/assets/js/page-39e05f8b.0875809c.js"><link rel="prefetch" href="/assets/js/page-3ab0cb1c.d138b225.js"><link rel="prefetch" href="/assets/js/page-3c8dbd4b.c82e45b6.js"><link rel="prefetch" href="/assets/js/page-3cdc4745.64111097.js"><link rel="prefetch" href="/assets/js/page-3cfa4e13.17b20dee.js"><link rel="prefetch" href="/assets/js/page-3ff73aa5.5ba7ac73.js"><link rel="prefetch" href="/assets/js/page-4107293f.a843750e.js"><link rel="prefetch" href="/assets/js/page-4144513c.1cdd4195.js"><link rel="prefetch" href="/assets/js/page-422a7e52.85359ce8.js"><link rel="prefetch" href="/assets/js/page-445c88ce.92dabe6e.js"><link rel="prefetch" href="/assets/js/page-4478a866.97464351.js"><link rel="prefetch" href="/assets/js/page-455360d1.409239c9.js"><link rel="prefetch" href="/assets/js/page-47f71914.4afab433.js"><link rel="prefetch" href="/assets/js/page-4829d184.186db358.js"><link rel="prefetch" href="/assets/js/page-486aacae.1b9cbb90.js"><link rel="prefetch" href="/assets/js/page-4d521b14.8c8801aa.js"><link rel="prefetch" href="/assets/js/page-4d7e2aa5.86be9444.js"><link rel="prefetch" href="/assets/js/page-4d9fba32.a732da2a.js"><link rel="prefetch" href="/assets/js/page-4dc00f25.b04f5f2a.js"><link rel="prefetch" href="/assets/js/page-4dc54ba5.f01971f8.js"><link rel="prefetch" href="/assets/js/page-4df429d2.277acbee.js"><link rel="prefetch" href="/assets/js/page-518ca8d8.5aa8f541.js"><link rel="prefetch" href="/assets/js/page-545b8d99.3f33c018.js"><link rel="prefetch" href="/assets/js/page-55a376be.327c1be1.js"><link rel="prefetch" href="/assets/js/page-59cd63bf.2d68c60f.js"><link rel="prefetch" href="/assets/js/page-5cdb680e.a85dc101.js"><link rel="prefetch" href="/assets/js/page-5de41bb6.ace3166b.js"><link rel="prefetch" href="/assets/js/page-5edad598.1b989a83.js"><link rel="prefetch" href="/assets/js/page-63d82e5a.dc3d864f.js"><link rel="prefetch" href="/assets/js/page-64a9a694.95c3a694.js"><link rel="prefetch" href="/assets/js/page-66061c06.ebbb2650.js"><link rel="prefetch" href="/assets/js/page-6890df9a.ff970e97.js"><link rel="prefetch" href="/assets/js/page-68b44e7f.e22b7cf6.js"><link rel="prefetch" href="/assets/js/page-6dbff0ea.b2f17958.js"><link rel="prefetch" href="/assets/js/page-6f7fa8b4.36df2ef0.js"><link rel="prefetch" href="/assets/js/page-70612fe6.59a14a9f.js"><link rel="prefetch" href="/assets/js/page-720c8312.8e3348eb.js"><link rel="prefetch" href="/assets/js/page-74a44f51.0db1d555.js"><link rel="prefetch" href="/assets/js/page-7507c3f6.d76cabb4.js"><link rel="prefetch" href="/assets/js/page-761a0ef6.5af0ec47.js"><link rel="prefetch" href="/assets/js/page-7690c622.3dc4499b.js"><link rel="prefetch" href="/assets/js/page-777196ab.d9ad236b.js"><link rel="prefetch" href="/assets/js/page-793331a0.e07e1c2d.js"><link rel="prefetch" href="/assets/js/page-7ba2451f.179b57eb.js"><link rel="prefetch" href="/assets/js/page-7bfb30a6.5d6e04d1.js"><link rel="prefetch" href="/assets/js/page-7d3a6963.c78fa884.js"><link rel="prefetch" href="/assets/js/page-7e6b5e12.b552635b.js"><link rel="prefetch" href="/assets/js/page-7f3fbf36.a8f2b6c8.js"><link rel="prefetch" href="/assets/js/page-82c2c642.e3854d1c.js"><link rel="prefetch" href="/assets/js/page-85f4c948.69ae9102.js"><link rel="prefetch" href="/assets/js/page-8892394c.ddd8d18c.js"><link rel="prefetch" href="/assets/js/page-89b130dc.b8d4e330.js"><link rel="prefetch" href="/assets/js/page-8da9df6c.548e81c5.js"><link rel="prefetch" href="/assets/js/page-916af89c.ad474bea.js"><link rel="prefetch" href="/assets/js/page-9a2a43a4.6ca0891e.js"><link rel="prefetch" href="/assets/js/page-9ec1a766.54087ad8.js"><link rel="prefetch" href="/assets/js/page-9f0190e0.22f5787c.js"><link rel="prefetch" href="/assets/js/page-a6174872.2d1f5570.js"><link rel="prefetch" href="/assets/js/page-aab392fc.65cc7f74.js"><link rel="prefetch" href="/assets/js/page-ace574d0.80a70d5b.js"><link rel="prefetch" href="/assets/js/page-ad24ce34.9a4beafa.js"><link rel="prefetch" href="/assets/js/page-b0521034.a92bbb5a.js"><link rel="prefetch" href="/assets/js/page-b0d90ce6.363e672e.js"><link rel="prefetch" href="/assets/js/page-b40de7ce.f5a54743.js"><link rel="prefetch" href="/assets/js/page-c26b0310.1dd6a2c0.js"><link rel="prefetch" href="/assets/js/page-c405dd3e.81b35c7f.js"><link rel="prefetch" href="/assets/js/page-c4bdd70e.f5d3301d.js"><link rel="prefetch" href="/assets/js/page-c5f1a60e.2ae26796.js"><link rel="prefetch" href="/assets/js/page-c60be50a.9e74594f.js"><link rel="prefetch" href="/assets/js/page-d3e58f16.0ea89e68.js"><link rel="prefetch" href="/assets/js/page-d6c4343e.901c8fcc.js"><link rel="prefetch" href="/assets/js/page-e468b710.06c080a5.js"><link rel="prefetch" href="/assets/js/page-e72e49e8.f8251eb4.js"><link rel="prefetch" href="/assets/js/page-ec44d602.194ac997.js"><link rel="prefetch" href="/assets/js/page-ed303fba.b05c9305.js"><link rel="prefetch" href="/assets/js/page-f313c186.fd7c616e.js"><link rel="prefetch" href="/assets/js/page-f6776002.5077cb03.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.fa9e1e07.js"><link rel="prefetch" href="/assets/js/vendors~layout-Layout.95643146.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9984fa41.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-12c3b9f4 data-v-7bf1726c><!----> <div class="sidebar-content active-display" data-v-12c3b9f4><div class="view-container" data-v-12c3b9f4><!----></div></div> <div class="content view-container disactive-displayer" data-v-12c3b9f4><!----></div> <!----> <div class="content__default" style="display:none;" data-v-12c3b9f4><p><a href="/Coding/Website/vue-dotnetcore-scaffolding/authentication.html">承接上篇</a>，建立了一個<code>Cookie-Based</code>的認證方式</p> <p>這回要做的是網頁的閒置登出機制</p> <p>網頁的閒置登出機制可以很簡單、很單純，也可以非常的複雜</p> <p>比較簡單來說，大概就是登入後放置個幾秒就把你登出</p> <h1 id="需求">需求</h1> <p>而以下是這次要來挑戰的目標</p> <ol><li><p>閒置10分鐘要跳<code>閒置警告</code></p></li> <li><p><code>閒置警告</code></p> <ul><li><p>倒數1分鐘後觸發<code>強制登出</code></p></li> <li><p><code>閒置警告</code>可以跳出來2次</p></li> <li><p>當第3次閒置時，觸發<code>強制登出</code></p></li></ul></li> <li><p><code>強制登出</code></p> <ul><li><p>要跳到首頁</p></li> <li><p>要顯示提示訊息，讓user按下確定才會關</p></li></ul></li> <li><p><em><strong>閒置登出機制要跨瀏覽器分頁</strong></em></p></li> <li><p><em><strong>閒置登出機制要能在手機上作用</strong></em></p></li></ol> <p>完成後的demo如下:</p> <ul><li>在示意影片中:
<ul><li>閒置10分鐘調整成閒置3秒鐘</li> <li>閒置警告倒數1分鐘調整成5秒鐘</li></ul></li></ul> <p><video controls="controls" preload="metadata"><source type="video/mp4" src="/assets/media/page-idle(2020-11-16).45ce86f5.mp4">
Your browser does not support playing HTML5 video. You can <a href="./img-page-idle/page-idle(2020-11-16).mp4" download="">download a copy of the video file</a> instead.
</video></p> <h1 id="需求分析">需求分析</h1> <h2 id="baseline">Baseline</h2> <p>首先，當在桌電上，且單一網頁的情況下，條件1~3其實還算是單純的</p> <p>直觀上來說，可以做個2層的巢狀Timeout，在配合上user停止動作後去觸發第一層Timeout來進行實作</p> <p>以下是概略架構:</p> <div class="language-js extra-class"><pre class="language-js"><code>Timer1 <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    Timer2 <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token comment">// 執行強制登出</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token comment">// 倒數1分鐘</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token punctuation">)</span> <span class="token comment">// 倒數10分鐘</span>
</code></pre></div><p>接著搭配事件綁定來觸發RunTimer1</p> <p>每次執行RunTimer1時，都先把Timer1給清掉</p> <p>這樣就能做到user有動作就重新計算閒置時間的功能</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">RunTimer1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">clearInterval</span><span class="token punctuation">(</span>Timer1<span class="token punctuation">)</span>
    Timer1<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// js沒有這個指令，這邊只是示意</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> unidleEvents <span class="token operator">=</span> <span class="token string">&quot;mousemove click mouseup mousedown keydown keypress keyup submit change mouseenter scroll resize dblclick&quot;</span>
<span class="token function">$</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>unidleEvents<span class="token punctuation">,</span> RunTimer1<span class="token punctuation">)</span>
</code></pre></div><p>而以上的事件綁定我們可以用 <code>throttle</code> 來改善效能</p> <p>如果不進行改善的話，光是滑鼠的移動，就會觸發非常多次的 RunTimer1</p> <p>而加上 <code>throttle</code> 的話，則可以讓指定的function在一定時間內只被執行一次 <sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">$</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>unidleEvents<span class="token punctuation">,</span> <span class="token function">throttle</span><span class="token punctuation">(</span>RunTimer1<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="問題點">問題點</h3> <ol><li><p>多分頁</p> <ul><li><p>問題</p> <p>很顯然的，當多分頁的情況下，光是閒置倒數的時間就會不同</p> <p>畢竟 RunTimer1 會在不同的時間點被啟動</p></li> <li><p>解法</p> <p>為了同步跨分頁的Timer，可以利用 <code>localStorage</code> 來進行資料的儲存</p> <p>並利用 Vue 響應式的機制來觸發主要邏輯</p></li></ul></li> <li><p>手機</p> <ul><li><p>問題</p> <p>若 User 使用手機進行瀏覽時，若完成登入後，看沒多久，就使用其他APP</p> <p>那網頁上的Timer，由於手機效能考量的設計，Timer是不會繼續倒數計時的</p> <p>因此如果現在是倒數50秒跳出，當 User 切換到其他APP使用了100秒後回到網頁</p> <p>那網頁上的時間還是會在50秒</p></li> <li><p>解法</p> <p>將 <code>setTimeout</code> 改成 <code>setInterval</code> 並且當 User 開始閒置時，設置一個<code>初始時間點</code></p> <p>讓 interval 不斷地用現在的時間跟<code>初始時間點</code>做計算</p> <p>這樣當 User 從其他 app 切回來時，時間的計算就會對上了</p></li></ul></li> <li><p>極端一點來說</p> <p>若在電腦上剛完成登入就關掉分頁，一個小時候重新開啟這個分頁，那麼理論上應該要直接登出</p> <p>但如果用 <code>setTimeout</code> 的方式，將可能會變成僅觸發 <code>閒置警告</code>，或者還在偵測閒置時間，連<code>閒置警告</code>都不會跳出</p></li></ol> <h2 id="nested-interval-approach">Nested Interval Approach</h2> <p>綜合以上，若以 Baseline 中，巢狀 Timeout 為基礎，用 <code>setInterval</code> 來進行改造:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> startTimestamp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
Timer1 <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTimestamp <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 倒數10分鐘</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token function">clearInterval</span><span class="token punctuation">(</span>Timer1<span class="token punctuation">)</span>
    startTimestamp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    Timer2 <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTimestamp <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 倒數1分鐘</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        <span class="token function">clearInterval</span><span class="token punctuation">(</span>Timer2<span class="token punctuation">)</span>
        <span class="token comment">// 執行強制登出</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">200</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">200</span> <span class="token punctuation">)</span>
</code></pre></div><h3 id="問題點-2">問題點</h3> <ol><li><p>最明顯的地方在於，沒有使用 <code>localStorage</code> 因此時間變數還是沒辦法跨分頁共享</p></li> <li><p>再來還有一個問題，當網頁進入<code>閒置警告</code>時，若時間變數已經從 <code>localStorage</code> 中得到同步</p> <p>這時如果開新的分頁進入網頁，那新的網頁會優先進入 Timer1 這時如果內部的邏輯沒處理好</p> <p>將可能導致新的分頁不會進入<code>閒置警告</code>的畫面</p></li></ol> <h2 id="reactive-interval-approach">Reactive Interval Approach</h2> <p>其實以上的Approach遇到很多狀況都需要作出很複雜的處理</p> <p>比方說登出時Timer要停掉，登入時Timer要啟動，多分頁資料的同步也是個大學問</p> <p>因此為了讓各種狀況變得比較好應對，我採用響應式的方式來進行實作，基本理念如下</p> <ol><li><p>將 Vuex store 改成儲存在 localStorage</p> <p>這樣就可能在開發時正常操作 store，然後利用 store.commit 來同步資料到 localStorage</p></li> <li><p>將閒置次數區分成 local 與 golbal(存在localStorage)</p> <p>由於閒置3次要<code>強制登出</code>，那就必須要有個變數紀錄目前閒置幾次</p> <p>如果每次觸發<code>閒置警告</code>，每個分頁都幫 localStorage 中的<code>閒置次數</code>+1</p> <p>那有幾個分頁就會增加幾次，那樣次數就會亂掉了</p> <p>因此，在閒置次數的判斷上，可以用 local 的閒置次數進行判斷</p> <p>當網頁第一次載入時，從localStorage將值assign到local閒置次數中</p> <p>當確定要增加次數時，先幫自己+1，接著用 assign 的方式塞到 localStorage</p> <p>這樣不管assign幾次，localStorage中的值都不會被重複增加</p></li> <li><p>設定閒置狀態</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">enum</span> IdleDetermineStates<span class="token punctuation">{</span>
    ByPass<span class="token punctuation">,</span>       <span class="token comment">// 不須使用閒置登出狀態</span>
    PageIdle<span class="token punctuation">,</span>     <span class="token comment">// 要觀察網頁是否閒置</span>
    UserComfirm<span class="token punctuation">,</span>  <span class="token comment">// 要進行閒置警告的倒數</span>
    Logout<span class="token punctuation">,</span>       <span class="token comment">// 執行登出的動作</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>設置一個 Interval</p> <p>使用一個 Interval ，在網頁載入後就啟動不停止</p> <p>並根據現在的閒置狀態來進行時間的計算，以及狀態的轉移</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> intervalRunner <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>pageIdle<span class="token punctuation">.</span>idleDetermineStates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> IdleDetermineStates<span class="token punctuation">.</span>PageIdle<span class="token punctuation">:</span>
          passSeconds <span class="token operator">=</span> 閒置秒數
          <span class="token keyword">if</span> <span class="token punctuation">(</span> passSeconds <span class="token operator">&gt;=</span> idleSeconds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">SetIdleDetermineStates</span><span class="token punctuation">(</span>IdleDetermineStates<span class="token punctuation">.</span>UserComfirm<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">break</span>

      <span class="token keyword">case</span> IdleDetermineStates<span class="token punctuation">.</span>UserComfirm<span class="token punctuation">:</span>
          remainUserComfirmSeconds <span class="token operator">=</span> 倒數計時秒數
          <span class="token keyword">if</span> <span class="token punctuation">(</span> remainUserComfirmSeconds <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">SetIdleDetermineStates</span><span class="token punctuation">(</span>IdleDetermineStates<span class="token punctuation">.</span>Logout<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">break</span>

      <span class="token keyword">case</span> IdleDetermineStates<span class="token punctuation">.</span>Logout<span class="token punctuation">:</span>
          <span class="token function">SetIdleDetermineStates</span><span class="token punctuation">(</span>IdleDetermineStates<span class="token punctuation">.</span>ByPass<span class="token punctuation">)</span>
          <span class="token keyword">break</span>

      <span class="token keyword">case</span> IdleDetermineStates<span class="token punctuation">.</span>ByPass<span class="token punctuation">:</span>
      <span class="token keyword">default</span><span class="token punctuation">:</span>
          <span class="token keyword">break</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">250</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>設置 watcher 以應對閒置狀態的改變</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">watch</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>pageIdle<span class="token punctuation">.</span>idleDetermineStates<span class="token punctuation">,</span> 
    <span class="token punctuation">(</span><span class="token parameter">newStates<span class="token punctuation">:</span> IdleDetermineStates<span class="token punctuation">,</span> oldStates<span class="token punctuation">:</span> IdleDetermineStates</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStates <span class="token operator">==</span> IdleDetermineStates<span class="token punctuation">.</span>PageIdle <span class="token operator">&amp;&amp;</span> 
            newStates <span class="token operator">==</span> IdleDetermineStates<span class="token punctuation">.</span>UserComfirm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">AddIdleTimes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> idleRemainTimes <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">SetIdleDetermineStates</span><span class="token punctuation">(</span>IdleDetermineStates<span class="token punctuation">.</span>Logout<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
              <span class="token function">SetIsShowUserConfirm</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
  
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStates <span class="token operator">==</span> IdleDetermineStates<span class="token punctuation">.</span>UserComfirm <span class="token operator">&amp;&amp;</span> 
            newStates <span class="token operator">==</span> IdleDetermineStates<span class="token punctuation">.</span>Logout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">Logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">SetIsShowLogOutNotification</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>Assign 計算時間點</p> <p>當 User 有在使用網頁時，就同步紀錄閒置時間的起始時間點 &amp; 閒置警告的起始時間點</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">SetTimeStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> startIdleTimestamp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> startUserConfirmTimestamp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span> <span class="token punctuation">(</span>startIdleTimestamp<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> props<span class="token punctuation">.</span>idleSeconds <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">+</span> <span class="token number">250</span><span class="token punctuation">)</span>
    store<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">&quot;pageIdle/SetStartIdleTimestamp&quot;</span><span class="token punctuation">,</span> startIdleTimestamp<span class="token punctuation">)</span>
    store<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">&quot;pageIdle/SetStartUserConfirmTimestamp&quot;</span><span class="token punctuation">,</span> startUserConfirmTimestamp<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">PageIdleHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>pageIdle<span class="token punctuation">.</span>idleDetermineStates <span class="token operator">==</span> IdleDetermineStates<span class="token punctuation">.</span>PageIdle<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">SetTimeStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">$</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>unidleEvents<span class="token punctuation">,</span> <span class="token function">throttle</span><span class="token punctuation">(</span>PageIdleHandler<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
</code></pre></div></li></ol> <h1 id="安裝套件">安裝套件</h1> <p>為了達成以上的需求，以下是這次所安裝的套件</p> <h2 id="vuex-multi-tab-state">vuex-multi-tab-state</h2> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> -D vuex-multi-tab-state
</code></pre></div><p>透過在 plugins 中進行註冊，就能直接讓 store 裡的資料儲存在 localStorage 中</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vuex'</span>

<span class="token keyword">import</span> createMultiTabState <span class="token keyword">from</span> <span class="token string">'vuex-multi-tab-state'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">createStore</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  state<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  mutations<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  actions<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  modules<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token function">createMultiTabState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>但在使用上有幾個地方要小心</p> <ol><li><p>型別</p> <p>由於 localStorage 中只能儲存字串，因此在拿取資料時，比方說 Date Type 的資料時，要進行轉型一下會比較保險</p></li> <li><p>更新機制</p> <p>有時為了方便，會使用 <code>store.state.variable = something</code> 的方式來異動資料</p> <p>但這樣的寫法會無法使 <code>vuex-multi-tab-state</code> 同步更新 localStorage</p> <p>必須使用 mutation 的方式，套件才能將資料進行同步</p></li></ol> <h2 id="jquery">jquery</h2> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> -D jquery
<span class="token function">npm</span> <span class="token function">install</span> -D @types/jquery // 由於有使用到 typescript ，因此要再安裝他的一些定義
</code></pre></div><h2 id="lodash">lodash</h2> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> -D lodash.debounce
<span class="token function">npm</span> <span class="token function">install</span> -D @types/lodash.debounce
<span class="token function">npm</span> <span class="token function">install</span> -D lodash.throttle
<span class="token function">npm</span> <span class="token function">install</span> -D @types/lodash.throttle
</code></pre></div><h2 id="vue-toastification">vue-toastification</h2> <p>用來進行登出時，右上跳出通知的處理</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> -D vue-toastification@next
</code></pre></div><h2 id="material-design-icons">material-design-icons</h2> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> -D material-design-icons
</code></pre></div><h2 id="animate-css">animate.css</h2> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> -D animate.css
</code></pre></div><h1 id="前後端閒置狀態連動機制">前後端閒置狀態連動機制</h1> <p>如果前端 User 一直使用，卻剛好都沒有呼叫到後端的功能的話，後端是有可能自己閒置登出的</p> <p>因此可以設置一個 <code>KeepAlive()</code> 確定 User 有在動作後，每隔30秒就呼叫一次後端，來避免後端自己閒置登出</p> <ul><li><p>後端部分</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// for refreshing session</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
<span class="token punctuation">[</span><span class="token class-name">HttpPost</span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token class-name">ActionResult</span> <span class="token function">KeepAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>前端部分</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">$</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>unidleEvents <span class="token punctuation">,</span> <span class="token function">debounce</span><span class="token punctuation">(</span>KeepAlive<span class="token punctuation">,</span> <span class="token number">30</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>關於 debounce 可以參考 <sup class="footnote-ref"><a href="#fn1" id="fnref1:1">[1:1]</a></sup></p></li></ul> <h1 id="測試">測試</h1> <p>雖然<a href="#%E9%9C%80%E6%B1%82">需求</a>的描述只有少少的幾行，跟5個列點，但實際上，第4跟第5點一加下去</p> <p>WOW，要測的edge case就不少了，這邊就先簡單條列一些狀況:</p> <ol><li>開多個分頁，登入後閒置，每個分頁要一起跳出閒置警告畫面</li> <li>使用過程中若不斷 F5，狀態不能錯(閒置次數要對、閒置狀態要對 ...)</li> <li>在閒置警告畫面出現時開新分頁，要能夠正確顯示閒置警告畫面</li> <li>登入後就關掉網頁，過了閒置時間+等待確認時間後再重新打開分頁，應該要登出</li> <li>用手機時，用一半跑去用其他app後再回來，時間跟狀態的計算要對</li></ol> <h1 id="總結來說">總結來說</h1> <p>由於資料會異步更新，因此非常的考驗開發時頭腦的清晰度，否則狀態很容易就弄錯了</p> <p>再來，開發時能避免巢狀還是儘量避免得好，對腦細胞來說比較友善一點(?</p> <p>雖然處理多工的難度比較大，但實作出來後的成就感也是滿大的</p> <p>以上就是一個小小的閒置登出機制，<a href="https://github.com/Jchou24/vue3-donetcore3-spa-page-idle-template" target="_blank" rel="noopener noreferrer">完整的Code在此<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 歡迎參考看看啦</p> <hr class="footnotes-sep"> <section class="footnotes"><ol class="footnotes-list"><li id="fn1" class="footnote-item"><p>關於 <code>throttle</code>, <code>debounce</code> 可以到<a href="http://demo.nimius.net/debounce_throttle/" target="_blank" rel="noopener noreferrer">這個網站<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>來玩玩看，應該會更有感覺 <a href="#fnref1" class="footnote-backref">↩︎</a> <a href="#fnref1:1" class="footnote-backref">↩︎</a></p></li></ol></section></div></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.c7870012.js" defer></script><script src="/assets/js/layout-Layout.29445450.js" defer></script><script src="/assets/js/page-11a8df82.4cea3682.js" defer></script>
  </body>
</html>

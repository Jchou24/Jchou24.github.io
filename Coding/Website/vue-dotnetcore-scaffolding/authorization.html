<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue3 + .Net Core3 SPA + Role-Based Authorization | VueJCBlog</title>
    <meta name="description" content="A Blog made by Vuepress">
    <link rel="icon" href="/icon.png">
  <link rel="manifest" href="/manifest.webmanifest">
    <meta property="og:site_name" content="VueJCBlog"><meta property="og:title" content="Vue3 + .Net Core3 SPA + Role-Based Authorization"><meta property="og:type" content="website"><meta property="og:url" content="/Coding/Website/vue-dotnetcore-scaffolding/authorization.html"><meta name="twitter:title" content="Vue3 + .Net Core3 SPA + Role-Based Authorization"><meta name="twitter:url" content="/Coding/Website/vue-dotnetcore-scaffolding/authorization.html"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:label1" content="Written by"><meta name="twitter:label2" content="Filed under"><meta name="twitter:data2" content="user, public, db, role, set, ef, admin, entity, userroles, table, userrole, 資料, int, id, modelbuilder, authorization, mapuserrole, 進行, email, 機制, csharp, core, 透過, 這邊, new, 參考, 認證, 設置, accountstatus, models"><meta property="article:tag" content="user"><meta property="article:tag" content="public"><meta property="article:tag" content="db"><meta property="article:tag" content="role"><meta property="article:tag" content="set"><meta property="article:tag" content="ef"><meta property="article:tag" content="admin"><meta property="article:tag" content="entity"><meta property="article:tag" content="userroles"><meta property="article:tag" content="table"><meta property="article:tag" content="userrole"><meta property="article:tag" content="資料"><meta property="article:tag" content="int"><meta property="article:tag" content="id"><meta property="article:tag" content="modelbuilder"><meta property="article:tag" content="authorization"><meta property="article:tag" content="mapuserrole"><meta property="article:tag" content="進行"><meta property="article:tag" content="email"><meta property="article:tag" content="機制"><meta property="article:tag" content="csharp"><meta property="article:tag" content="core"><meta property="article:tag" content="透過"><meta property="article:tag" content="這邊"><meta property="article:tag" content="new"><meta property="article:tag" content="參考"><meta property="article:tag" content="認證"><meta property="article:tag" content="設置"><meta property="article:tag" content="accountstatus"><meta property="article:tag" content="models">
    <link rel="preload" href="/assets/css/0.styles.9984fa41.css" as="style"><link rel="preload" href="/assets/js/app.c7870012.js" as="script"><link rel="preload" href="/assets/js/layout-Layout.29445450.js" as="script"><link rel="preload" href="/assets/js/page-7ba2451f.179b57eb.js" as="script"><link rel="prefetch" href="/assets/js/1.666c7553.js"><link rel="prefetch" href="/assets/js/116.04edb76b.js"><link rel="prefetch" href="/assets/js/117.ac275b69.js"><link rel="prefetch" href="/assets/js/118.ff18e79b.js"><link rel="prefetch" href="/assets/js/119.c856bbc7.js"><link rel="prefetch" href="/assets/js/120.9c35d03e.js"><link rel="prefetch" href="/assets/js/121.4c5a24a0.js"><link rel="prefetch" href="/assets/js/122.6f26c9b4.js"><link rel="prefetch" href="/assets/js/123.31b79da2.js"><link rel="prefetch" href="/assets/js/124.cf0261c9.js"><link rel="prefetch" href="/assets/js/125.69c7d910.js"><link rel="prefetch" href="/assets/js/126.32d079e6.js"><link rel="prefetch" href="/assets/js/127.837a3a82.js"><link rel="prefetch" href="/assets/js/128.b1694b54.js"><link rel="prefetch" href="/assets/js/129.8465e37c.js"><link rel="prefetch" href="/assets/js/130.9ac035fa.js"><link rel="prefetch" href="/assets/js/131.fd3bd900.js"><link rel="prefetch" href="/assets/js/132.6f6776e8.js"><link rel="prefetch" href="/assets/js/133.9716d0e0.js"><link rel="prefetch" href="/assets/js/134.6d4c14ab.js"><link rel="prefetch" href="/assets/js/135.ee7b8cd2.js"><link rel="prefetch" href="/assets/js/136.cd9a8afb.js"><link rel="prefetch" href="/assets/js/137.b4e66c79.js"><link rel="prefetch" href="/assets/js/138.f82ac177.js"><link rel="prefetch" href="/assets/js/139.9ad3847d.js"><link rel="prefetch" href="/assets/js/140.664c056a.js"><link rel="prefetch" href="/assets/js/2.b335b60d.js"><link rel="prefetch" href="/assets/js/3.f5362870.js"><link rel="prefetch" href="/assets/js/4.92687a32.js"><link rel="prefetch" href="/assets/js/5.f132b447.js"><link rel="prefetch" href="/assets/js/6.234d5839.js"><link rel="prefetch" href="/assets/js/layout-BaseLayout.37ed891a.js"><link rel="prefetch" href="/assets/js/layout-NotFound.351563b2.js"><link rel="prefetch" href="/assets/js/page-0193e625.cbe0c876.js"><link rel="prefetch" href="/assets/js/page-021b3aa4.9b00c44b.js"><link rel="prefetch" href="/assets/js/page-0a921c99.cccbfc74.js"><link rel="prefetch" href="/assets/js/page-0c6c4d65.5c8e3650.js"><link rel="prefetch" href="/assets/js/page-0c7f77bc.69a91bf3.js"><link rel="prefetch" href="/assets/js/page-0d32e5ee.4073d4ab.js"><link rel="prefetch" href="/assets/js/page-0e69d9d2.17047452.js"><link rel="prefetch" href="/assets/js/page-1080dbe2.3c97bc00.js"><link rel="prefetch" href="/assets/js/page-11a8df82.4cea3682.js"><link rel="prefetch" href="/assets/js/page-1486eb54.958c3954.js"><link rel="prefetch" href="/assets/js/page-177d640c.72680242.js"><link rel="prefetch" href="/assets/js/page-1a34eb5d.fc52abac.js"><link rel="prefetch" href="/assets/js/page-1c4a4e12.385c1707.js"><link rel="prefetch" href="/assets/js/page-1ccc22d8.f18fb3c5.js"><link rel="prefetch" href="/assets/js/page-1db42de8.1b9883d3.js"><link rel="prefetch" href="/assets/js/page-1e536af9.bf024de0.js"><link rel="prefetch" href="/assets/js/page-21fcb945.ec0399d3.js"><link rel="prefetch" href="/assets/js/page-25bc4f18.b58fbbb8.js"><link rel="prefetch" href="/assets/js/page-27f6ecec.04d3fd50.js"><link rel="prefetch" href="/assets/js/page-29c918e5.b244c75e.js"><link rel="prefetch" href="/assets/js/page-2c6bc4ab.7a9acfdd.js"><link rel="prefetch" href="/assets/js/page-2e8c0cd0.5980fb01.js"><link rel="prefetch" href="/assets/js/page-302e6251.28c13f5d.js"><link rel="prefetch" href="/assets/js/page-320aac86.bf2cf2b8.js"><link rel="prefetch" href="/assets/js/page-339369e0.497f9705.js"><link rel="prefetch" href="/assets/js/page-36d5d2b3.7bba3fcf.js"><link rel="prefetch" href="/assets/js/page-39e05f8b.0875809c.js"><link rel="prefetch" href="/assets/js/page-3ab0cb1c.d138b225.js"><link rel="prefetch" href="/assets/js/page-3c8dbd4b.c82e45b6.js"><link rel="prefetch" href="/assets/js/page-3cdc4745.64111097.js"><link rel="prefetch" href="/assets/js/page-3cfa4e13.17b20dee.js"><link rel="prefetch" href="/assets/js/page-3ff73aa5.5ba7ac73.js"><link rel="prefetch" href="/assets/js/page-4107293f.a843750e.js"><link rel="prefetch" href="/assets/js/page-4144513c.1cdd4195.js"><link rel="prefetch" href="/assets/js/page-422a7e52.85359ce8.js"><link rel="prefetch" href="/assets/js/page-445c88ce.92dabe6e.js"><link rel="prefetch" href="/assets/js/page-4478a866.97464351.js"><link rel="prefetch" href="/assets/js/page-455360d1.409239c9.js"><link rel="prefetch" href="/assets/js/page-47f71914.4afab433.js"><link rel="prefetch" href="/assets/js/page-4829d184.186db358.js"><link rel="prefetch" href="/assets/js/page-486aacae.1b9cbb90.js"><link rel="prefetch" href="/assets/js/page-4d521b14.8c8801aa.js"><link rel="prefetch" href="/assets/js/page-4d7e2aa5.86be9444.js"><link rel="prefetch" href="/assets/js/page-4d9fba32.a732da2a.js"><link rel="prefetch" href="/assets/js/page-4dc00f25.b04f5f2a.js"><link rel="prefetch" href="/assets/js/page-4dc54ba5.f01971f8.js"><link rel="prefetch" href="/assets/js/page-4df429d2.277acbee.js"><link rel="prefetch" href="/assets/js/page-518ca8d8.5aa8f541.js"><link rel="prefetch" href="/assets/js/page-545b8d99.3f33c018.js"><link rel="prefetch" href="/assets/js/page-55a376be.327c1be1.js"><link rel="prefetch" href="/assets/js/page-59cd63bf.2d68c60f.js"><link rel="prefetch" href="/assets/js/page-5cdb680e.a85dc101.js"><link rel="prefetch" href="/assets/js/page-5de41bb6.ace3166b.js"><link rel="prefetch" href="/assets/js/page-5edad598.1b989a83.js"><link rel="prefetch" href="/assets/js/page-63d82e5a.dc3d864f.js"><link rel="prefetch" href="/assets/js/page-64a9a694.95c3a694.js"><link rel="prefetch" href="/assets/js/page-66061c06.ebbb2650.js"><link rel="prefetch" href="/assets/js/page-6890df9a.ff970e97.js"><link rel="prefetch" href="/assets/js/page-68b44e7f.e22b7cf6.js"><link rel="prefetch" href="/assets/js/page-6dbff0ea.b2f17958.js"><link rel="prefetch" href="/assets/js/page-6f7fa8b4.36df2ef0.js"><link rel="prefetch" href="/assets/js/page-70612fe6.59a14a9f.js"><link rel="prefetch" href="/assets/js/page-720c8312.8e3348eb.js"><link rel="prefetch" href="/assets/js/page-74a44f51.0db1d555.js"><link rel="prefetch" href="/assets/js/page-7507c3f6.d76cabb4.js"><link rel="prefetch" href="/assets/js/page-761a0ef6.5af0ec47.js"><link rel="prefetch" href="/assets/js/page-7690c622.3dc4499b.js"><link rel="prefetch" href="/assets/js/page-777196ab.d9ad236b.js"><link rel="prefetch" href="/assets/js/page-793331a0.e07e1c2d.js"><link rel="prefetch" href="/assets/js/page-7bfb30a6.5d6e04d1.js"><link rel="prefetch" href="/assets/js/page-7d3a6963.c78fa884.js"><link rel="prefetch" href="/assets/js/page-7e6b5e12.b552635b.js"><link rel="prefetch" href="/assets/js/page-7f3fbf36.a8f2b6c8.js"><link rel="prefetch" href="/assets/js/page-82c2c642.e3854d1c.js"><link rel="prefetch" href="/assets/js/page-85f4c948.69ae9102.js"><link rel="prefetch" href="/assets/js/page-8892394c.ddd8d18c.js"><link rel="prefetch" href="/assets/js/page-89b130dc.b8d4e330.js"><link rel="prefetch" href="/assets/js/page-8da9df6c.548e81c5.js"><link rel="prefetch" href="/assets/js/page-916af89c.ad474bea.js"><link rel="prefetch" href="/assets/js/page-9a2a43a4.6ca0891e.js"><link rel="prefetch" href="/assets/js/page-9ec1a766.54087ad8.js"><link rel="prefetch" href="/assets/js/page-9f0190e0.22f5787c.js"><link rel="prefetch" href="/assets/js/page-a6174872.2d1f5570.js"><link rel="prefetch" href="/assets/js/page-aab392fc.65cc7f74.js"><link rel="prefetch" href="/assets/js/page-ace574d0.80a70d5b.js"><link rel="prefetch" href="/assets/js/page-ad24ce34.9a4beafa.js"><link rel="prefetch" href="/assets/js/page-b0521034.a92bbb5a.js"><link rel="prefetch" href="/assets/js/page-b0d90ce6.363e672e.js"><link rel="prefetch" href="/assets/js/page-b40de7ce.f5a54743.js"><link rel="prefetch" href="/assets/js/page-c26b0310.1dd6a2c0.js"><link rel="prefetch" href="/assets/js/page-c405dd3e.81b35c7f.js"><link rel="prefetch" href="/assets/js/page-c4bdd70e.f5d3301d.js"><link rel="prefetch" href="/assets/js/page-c5f1a60e.2ae26796.js"><link rel="prefetch" href="/assets/js/page-c60be50a.9e74594f.js"><link rel="prefetch" href="/assets/js/page-d3e58f16.0ea89e68.js"><link rel="prefetch" href="/assets/js/page-d6c4343e.901c8fcc.js"><link rel="prefetch" href="/assets/js/page-e468b710.06c080a5.js"><link rel="prefetch" href="/assets/js/page-e72e49e8.f8251eb4.js"><link rel="prefetch" href="/assets/js/page-ec44d602.194ac997.js"><link rel="prefetch" href="/assets/js/page-ed303fba.b05c9305.js"><link rel="prefetch" href="/assets/js/page-f313c186.fd7c616e.js"><link rel="prefetch" href="/assets/js/page-f6776002.5077cb03.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.fa9e1e07.js"><link rel="prefetch" href="/assets/js/vendors~layout-Layout.95643146.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9984fa41.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-12c3b9f4 data-v-7bf1726c><!----> <div class="sidebar-content active-display" data-v-12c3b9f4><div class="view-container" data-v-12c3b9f4><!----></div></div> <div class="content view-container disactive-displayer" data-v-12c3b9f4><!----></div> <!----> <div class="content__default" style="display:none;" data-v-12c3b9f4><p><a href="/Coding/Website/vue-dotnetcore-scaffolding/page-idle.html">承接上篇</a>，建立了一個網頁閒置偵測的機制</p> <p>這次要談的內容是 <code>authorization</code>(授權)</p> <p><code>authentication</code>(認證) 跟 <code>authorization</code>(授權)，關注的地方是不同的</p> <p>authentication 關注在身分的核對，旨在確認對方是會員</p> <p>而 authorization 關注在這個user他有什麼樣的權利，可以訪問哪些功能</p> <h1 id="authorization">Authorization</h1> <p>Authorization 的實作有相當多的類型，光是 .net 原生就提供了許多種設定方式 <sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup></p> <p>甚至是一些官方範例 <sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup></p> <p>網路上還有允許動態調整權限的範例 <sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup></p> <h2 id="role">Role</h2> <p>一個 User 自身可以擁有多種 role，若某A擁有 <code>admin</code> role</p> <p>他或許可以停權別人的帳號</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token class-name">Authorize</span><span class="token punctuation">(</span>Roles <span class="token operator">=</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">UpdateUserAccount</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// do something</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="policy">Policy</h2> <p>有的時候，我們可能會需要多個 role 才能存取一個 function</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token class-name">Authorize</span><span class="token punctuation">(</span>Roles <span class="token operator">=</span> <span class="token string">&quot;admin_read, admin_write&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">UpdateUserAccount</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// do something</span>
<span class="token punctuation">}</span>
</code></pre></div><p>那如果 role 的某些組合很常出現，那就必須要一直把他們寫出來</p> <p>這時就可以考慮用 policy，直接設定<code>admin policy</code>含有<code>admin_read</code> <code>admin_write</code> 兩個權限</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token class-name">Authorize</span><span class="token punctuation">(</span>Policy <span class="token operator">=</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">UpdateUserAccount</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// do something</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="why-custom-authorization">Why Custom Authorization</h2> <p>原生的 authorization 機制是滿完善的，但要使用他們會造成系統開發的一些限制</p> <ol><li><p>必須使用.net提供的DB結構，否則許多地方不僅要重造輪子，甚至會變成魔改</p></li> <li><p>為了運用.net提供的DB結構，會變成可能得要使用 Entity Framework，不然與DB聯動的部分還是得要自己重造輪子</p></li> <li><p>為了好好的運用前兩項的<code>限制</code>，必須要讓開發人員花時間去了解.net提供的<code>完整</code>認證授權機制</p> <p>如果系統不夠大，做這樣的付出，CP值可能不是很高</p></li> <li><p>如果運用了 .net 提供的機制，要自己做些客製化，難度會高出許多，還不如自己造輪子</p></li> <li><p>如果要純SPA的話，.net提供的範例都是MVC，即便是SPA的範例，在認證這塊也是用MVC實作</p> <p>所以這會導致無法做到純SPA，要純SPA，要改造的地方會非常的多</p></li></ol> <p>當然必須要說的是，原生的機制非常的強大與完整，但同時內容太多了</p> <p>如果只是要做一些簡單的認證授權機制，反而是有些不方便的</p> <h1 id="custom-authorization">Custom Authorization</h1> <p>綜上所述，這邊主要參考 stackoverflow 上的討論<sup class="footnote-ref"><a href="#fn4" id="fnref4">[4]</a></sup></p> <p>使用客製化的 <code>Authorization Action Filter</code> 與簡單的 Table 設計</p> <p>搭配 Entity Framework Core，Code First 策略來實作授權機制</p> <p>並使用MS SQL Server來存放DB，及SSMS來看DB中的資料</p> <h2 id="主要目標">主要目標</h2> <p>讓 weather api 可以被擁有 <code>User</code> 權限的用戶存取</p> <p>因此就算是擁有 <code>Admin</code> 權限的用戶，只要他沒有 <code>User</code> 的權限</p> <p>當他存取 weather api 時，依然要 401 Unauthorize</p> <p>以下影片為上述的示意</p> <p><video controls="controls" preload="metadata"><source type="video/mp4" src="/assets/media/authorization(2020-11-26).a5209887.mp4">
Your browser does not support playing HTML5 video. You can <a href="./img-authorization/authorization(2020-11-26).mp4" download="">download a copy of the video file</a> instead.
</video></p> <h2 id="why-entity-framework">Why Entity Framework</h2> <p>Entity Framework 是一種透過 ORM(Object Relational Mapping) 來存取DB的方式</p> <p>只要建立一些Class，描述清楚資料間的關聯，就可以直接用EF來創建/調整DB，並存取DB的資料</p> <p>會比自己手動寫SQL在程式裡安全，也會比自己寫 stored procedure 還要快速</p> <p>當然 EF 不是萬能的，有些時候要透過 EF 來達成複雜的 SQL 指令可能會有些難度</p> <p>因此簡單的 CRUD 可以使用 EF 來達到</p> <p>而當要處理複雜又講求效率的 SQL 時，就可以再使用其他方式達成(如stored procedure)</p> <p>想了解更多 EF 的東西的話，可以參考看看這些文章<sup class="footnote-ref"><a href="#fn5" id="fnref5">[5]</a></sup><sup class="footnote-ref"><a href="#fn6" id="fnref6">[6]</a></sup><sup class="footnote-ref"><a href="#fn7" id="fnref7">[7]</a></sup><sup class="footnote-ref"><a href="#fn8" id="fnref8">[8]</a></sup></p> <h2 id="開發流程">開發流程</h2> <p>首先，架構上，這次將會把資料<code>寫死在DB</code>，將不再把資料寫死在程式碼中</p> <p>因此會在專案中設計好DB的Table，再使用EF(Entity Framework)直接更新/建立DB</p> <p>並透過EF來存取DB中的資料</p> <p>接著會在之前的基礎上進行<code>認證</code>部分的改造，改為從DB讀資料，並且更改為<code>信箱</code>，<code>密碼</code>認證</p> <p>接著實作授權的機制</p> <h1 id="entity-framework">Entity Framework</h1> <h2 id="nuget-安裝">nuget 安裝</h2> <ul><li>Microsoft.AspNetCore.Identity.EntityFrameworkCore</li> <li>Microsoft.EntityFrameworkCore (提供EF一些更便捷的操作function)</li> <li>Microsoft.EntityFrameworkCore.Design (提供EF設計Table的API)</li> <li>Microsoft.EntityFrameworkCore.SqlServer (讓EF可以連到MSSQL)</li></ul> <h2 id="設計-table">設計 Table</h2> <p>Table 上主要要建2+1個 Table</p> <ol><li><p>User: 用來存User的主要資訊，像是姓名、Email、Password...</p> <ul><li><p>比較特別的是，密碼存的是經過Hash處理的字串，以防資料庫若不小心外洩，密碼會<code>比較</code>不容易外洩</p></li> <li><p>而密碼的運算，這邊主要參考自 stackoverflow 上的這邊 <sup class="footnote-ref"><a href="#fn9" id="fnref9">[9]</a></sup></p></li></ul></li> <li><p>User Role: 用來存目前有哪些 Role</p></li> <li><p>MapUserRole: 由於<code>User</code>跟<code>User Role</code>是Many-to-Many的關聯，因此需要這張Table紀錄這個關係</p></li></ol> <h2 id="建立-table">建立 Table</h2> <p>官方在關聯的說明上還算講的滿好懂得，有興趣可以多參考參考<sup class="footnote-ref"><a href="#fn8" id="fnref8:1">[8:1]</a></sup></p> <p>以下是這邊建立Table的一些說明</p> <ul><li><p>User</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 設定PK，並且讓Id可以auto increment</span>
    <span class="token punctuation">[</span><span class="token class-name">Key</span><span class="token punctuation">,</span> <span class="token function">DatabaseGenerated</span><span class="token punctuation">(</span>DatabaseGeneratedOption<span class="token punctuation">.</span>Identity<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token comment">// 利用 Data Anotation 標注是 Email</span>
    <span class="token comment">// 這樣還能自動進行欄位的後端驗證</span>
    <span class="token punctuation">[</span><span class="token class-name">DataType</span><span class="token punctuation">(</span>DataType<span class="token punctuation">.</span>EmailAddress<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> Email <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> PasswordHash <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">AccountStatus</span> AccountStatus <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment">// 以下兩個欄位是為了設定多對多的關係</span>
    <span class="token keyword">public</span> ICollection<span class="token operator">&lt;</span>UserRole<span class="token operator">&gt;</span> UserRoles <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">[</span><span class="token class-name">JsonIgnore</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> List<span class="token operator">&lt;</span>MapUserRole<span class="token operator">&gt;</span> MapUserRoles <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">User</span><span class="token punctuation">(</span><span class="token keyword">string</span> email<span class="token punctuation">,</span> <span class="token keyword">string</span> password<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>Email <span class="token operator">=</span> email<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>PasswordHash <span class="token operator">=</span> SecurePasswordHasher<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>AccountStatus <span class="token operator">=</span> AccountStatus<span class="token punctuation">.</span>Uncheck<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>User Role</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserRole</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token class-name">Key</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// for matching program code</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> CodeName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> DisplayName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token comment">// 透過設置 JsonIgnore，避免序列化資料到前端時產生循環參考</span>
    <span class="token punctuation">[</span><span class="token class-name">JsonIgnore</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> ICollection<span class="token operator">&lt;</span>User<span class="token operator">&gt;</span> Users <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">[</span><span class="token class-name">JsonIgnore</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> List<span class="token operator">&lt;</span>MapUserRole<span class="token operator">&gt;</span> MapUserRoles <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>MapUserRole</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MapUserRole</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token class-name">DatabaseGenerated</span><span class="token punctuation">(</span>DatabaseGeneratedOption<span class="token punctuation">.</span>Identity<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment">// 設置多對多關係</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> UserId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> UserRolesId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment">// 透過下面的語法設置ORM的多對多關係</span>
    <span class="token keyword">public</span> <span class="token class-name">User</span> User <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">UserRole</span> UserRoles <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>DB Context</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationDbContext</span> <span class="token punctuation">:</span> <span class="token class-name">IdentityDbContext</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">ApplicationDbContext</span><span class="token punctuation">(</span>DbContextOptions<span class="token operator">&lt;</span>ApplicationDbContext<span class="token operator">&gt;</span> options<span class="token punctuation">)</span>
        <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 將3張Table註冊起來，讓EF知道要建立的就是下面3張Table</span>
    <span class="token keyword">public</span> DbSet<span class="token operator">&lt;</span>User<span class="token operator">&gt;</span> User <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> DbSet<span class="token operator">&lt;</span>UserRole<span class="token operator">&gt;</span> UserRole <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> DbSet<span class="token operator">&lt;</span>MapUserRole<span class="token operator">&gt;</span> MapUserRoles <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">OnModelCreating</span><span class="token punctuation">(</span><span class="token class-name">ModelBuilder</span> modelBuilder<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 必須要加這行執行預設的行為，否則會無法正常執行指令</span>
        <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnModelCreating</span><span class="token punctuation">(</span>modelBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 透過 fluent api 將 Email 設置為 unique</span>
        modelBuilder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Entity</span><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">HasIndex</span><span class="token punctuation">(</span>u <span class="token operator">=&gt;</span> u<span class="token punctuation">.</span>Email<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">IsUnique</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 透過 fluent api 與以下語法建立多對多關係</span>
        modelBuilder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Entity</span><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">HasMany</span><span class="token punctuation">(</span>p <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span>UserRoles<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">WithMany</span><span class="token punctuation">(</span>p <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span>Users<span class="token punctuation">)</span>

            <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">UsingEntity</span><span class="token punctuation">&lt;</span><span class="token class-name">MapUserRole</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                j <span class="token operator">=&gt;</span> j
                    <span class="token punctuation">.</span><span class="token function">HasOne</span><span class="token punctuation">(</span>pt <span class="token operator">=&gt;</span> pt<span class="token punctuation">.</span>UserRoles<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">WithMany</span><span class="token punctuation">(</span>t <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>MapUserRoles<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">HasForeignKey</span><span class="token punctuation">(</span>pt <span class="token operator">=&gt;</span> pt<span class="token punctuation">.</span>UserRolesId<span class="token punctuation">)</span><span class="token punctuation">,</span>
                j <span class="token operator">=&gt;</span> j
                    <span class="token punctuation">.</span><span class="token function">HasOne</span><span class="token punctuation">(</span>pt <span class="token operator">=&gt;</span> pt<span class="token punctuation">.</span>User<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">WithMany</span><span class="token punctuation">(</span>p <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span>MapUserRoles<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">HasForeignKey</span><span class="token punctuation">(</span>pt <span class="token operator">=&gt;</span> pt<span class="token punctuation">.</span>UserId<span class="token punctuation">)</span><span class="token punctuation">,</span>
                j <span class="token operator">=&gt;</span>
                <span class="token punctuation">{</span>
                    j<span class="token punctuation">.</span><span class="token function">HasKey</span><span class="token punctuation">(</span>t <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token punctuation">{</span> t<span class="token punctuation">.</span>UserId<span class="token punctuation">,</span> t<span class="token punctuation">.</span>UserRolesId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 設置初始資料，後續會提到</span>
        <span class="token function">SeedData</span><span class="token punctuation">(</span>modelBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h2 id="seeddata">SeedData</h2> <p>有的系統在初始設計時，就會將一些參數初始化設置進DB當中，在 EF 裡也是允許做這件事的</p> <p>手段有很多種，一種是建立/更新DB時，一併把資料設置上去，一種是啟動系統時建立</p> <p>這邊採用前者來設置初始資料</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">SeedData</span><span class="token punctuation">(</span><span class="token class-name">ModelBuilder</span> modelBuilder<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// add admin, user</span>
    modelBuilder
        <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Entity</span><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">HasData</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;admin@auth.com&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;@Dmin&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            Id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
            Name <span class="token operator">=</span> <span class="token string">&quot;Admin&quot;</span><span class="token punctuation">,</span>
            AccountStatus <span class="token operator">=</span> AccountStatus<span class="token punctuation">.</span>Approved
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    modelBuilder
        <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Entity</span><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">HasData</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;user@auth.com&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;user1234&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            Id <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
            Name <span class="token operator">=</span> <span class="token string">&quot;User&quot;</span><span class="token punctuation">,</span>
            AccountStatus <span class="token operator">=</span> AccountStatus<span class="token punctuation">.</span>Approved
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// add role</span>
    modelBuilder
        <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Entity</span><span class="token punctuation">&lt;</span><span class="token class-name">UserRole</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">HasData</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UserRole</span>
        <span class="token punctuation">{</span>
            Id <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>Models<span class="token punctuation">.</span>UserRoles<span class="token punctuation">.</span>Admin<span class="token punctuation">,</span>
            CodeName <span class="token operator">=</span> Models<span class="token punctuation">.</span>UserRoles<span class="token punctuation">.</span>Admin<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            DisplayName <span class="token operator">=</span> Models<span class="token punctuation">.</span>UserRoles<span class="token punctuation">.</span>Admin<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    modelBuilder
        <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Entity</span><span class="token punctuation">&lt;</span><span class="token class-name">DBModels<span class="token punctuation">.</span>UserRole</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">HasData</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DBModels<span class="token punctuation">.</span>UserRole</span>
        <span class="token punctuation">{</span>
            Id <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>Models<span class="token punctuation">.</span>UserRoles<span class="token punctuation">.</span>User<span class="token punctuation">,</span>
            CodeName <span class="token operator">=</span> Models<span class="token punctuation">.</span>UserRoles<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            DisplayName <span class="token operator">=</span> Models<span class="token punctuation">.</span>UserRoles<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// update many-to-many relation</span>
    <span class="token comment">// add role of user</span>
    modelBuilder
        <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Entity</span><span class="token punctuation">&lt;</span><span class="token class-name">MapUserRole</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">HasData</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MapUserRole</span>
        <span class="token punctuation">{</span>
            UserId <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
            UserRolesId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>Models<span class="token punctuation">.</span>UserRoles<span class="token punctuation">.</span>Admin
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    modelBuilder
        <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Entity</span><span class="token punctuation">&lt;</span><span class="token class-name">MapUserRole</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">HasData</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MapUserRole</span>
        <span class="token punctuation">{</span>
            UserId <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
            UserRolesId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>Models<span class="token punctuation">.</span>UserRoles<span class="token punctuation">.</span>User
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="更新-建立-db">更新/建立 DB</h2> <p>當建立好用來對應Table的物件後，就可以透過 <code>dotnet-ef</code> 下指令來更新/建立DB了</p> <p>而要使用該指令前，會需要先使用 powershell/bash 來安裝該指令</p> <div class="language-bash extra-class"><pre class="language-bash"><code>dotnet tool <span class="token function">install</span> --global dotnet-ef
</code></pre></div><p>接著當第一次建立Table，或後續架構更改，都可以用以下指令來更新DB</p> <div class="language-bash extra-class"><pre class="language-bash"><code>dotnet ef migrations <span class="token function">add</span> InitialCreate
dotnet ef database update
</code></pre></div><p>當Table對應的Class有進行異動時，就可以使用以上指令來進行更新</p> <p>若希望留下歷程，可以把 InitialCreate 改為其他的名字</p> <p>這樣就可以在 Migrations 資料夾留下異動的紀錄</p> <p>而當DB有資料時，Table卻異動了，也可以使用指令來進行更新</p> <p>有些情況他會幫你處理資料的異動，但有些他判斷不行的，也會有錯誤訊息出來</p> <h2 id="包裝-di-db-context">包裝/DI DB Context</h2> <p>當在 API 的 Controller進行異動時，若在function裡面處理資料對DB的動作</p> <ol><li><p>會製造大量重複的邏輯</p></li> <li><p>會讓 Controller 中的邏輯變得複雜，可讀性降低</p></li></ol> <p>因此可以將一些對DB的邏輯包裝起來，透過 DI 的機制注入到 Controller 中使用</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">// Startup.cs</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 將 DB Context 注入</span>
    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddDbContext</span><span class="token punctuation">&lt;</span><span class="token class-name">ApplicationDbContext</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span>
        options<span class="token punctuation">.</span><span class="token function">UseSqlServer</span><span class="token punctuation">(</span>
            Configuration<span class="token punctuation">.</span><span class="token function">GetConnectionString</span><span class="token punctuation">(</span><span class="token string">&quot;DefaultConnection&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 將包裝起來的邏輯注入</span>
    services<span class="token punctuation">.</span>AddScoped<span class="token operator">&lt;</span>IUserAuthHandler<span class="token operator">&lt;</span>User<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> UserAuthHandler<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>AddScoped</code> 是代表注入的生命週期運作模式，詳情可以參考這邊<sup class="footnote-ref"><a href="#fn10" id="fnref10">[10]</a></sup></p> <h1 id="實作-authorization-attribute">實作 Authorization Attribute</h1> <p>實作的步驟大致為</p> <ol><li><p>建立 class 實作 IAuthorizationFilter</p></li> <li><p>從 session 中讀出使用者的 id</p></li> <li><p>利用 id 查出該 user 擁有哪些 role</p></li> <li><p>比對 user 的 role 跟 function 上設定的 role</p></li> <li><p>當比對OK才代表該 user 有被授權存取</p></li></ol> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizeActionFilter</span> <span class="token punctuation">:</span> <span class="token class-name">IAuthorizationFilter</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">UserRoles</span> _userRole<span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token keyword">readonly</span> IUserAuthHandler<span class="token operator">&lt;</span>User<span class="token punctuation">,</span><span class="token keyword">int</span><span class="token operator">&gt;</span> _authHandler<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token function">AuthorizeActionFilter</span><span class="token punctuation">(</span><span class="token class-name">UserRoles</span> userRole<span class="token punctuation">,</span> IUserAuthHandler<span class="token operator">&lt;</span>User<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">&gt;</span> authHandler<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_userRole <span class="token operator">=</span> userRole<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_authHandler <span class="token operator">=</span> authHandler<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">OnAuthorization</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationFilterContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 從 session 讀取 id</span>
        <span class="token keyword">int</span><span class="token punctuation">?</span> id <span class="token operator">=</span> context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">GetUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            context<span class="token punctuation">.</span>Result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UnauthorizedResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 讀取 user 擁有的 role</span>
        IEnumerable<span class="token operator">&lt;</span>UserRole<span class="token operator">&gt;</span> roles <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_authHandler<span class="token punctuation">.</span><span class="token function">FindById</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>id<span class="token punctuation">)</span><span class="token punctuation">?.</span>UserRoles<span class="token punctuation">;</span>

        <span class="token comment">// 進行 role 的比對</span>
        <span class="token keyword">bool</span> isAuthorized <span class="token operator">=</span> roles<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>CodeName<span class="token punctuation">.</span><span class="token function">ToLower</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_userRole<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLower</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isAuthorized<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            context<span class="token punctuation">.</span>Result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UnauthorizedResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h1 id="改造前端">改造前端</h1> <h2 id="testauthentication">TestAuthentication</h2> <p>由於之前測試認證是使用 Email，並且寫死測資</p> <p>這邊改寫成以 Email、密碼的方式來進行登入登出</p> <p>並將組建的名稱改為 <code>SignIn.vue</code> Code請<a href="https://github.com/Jchou24/vue3-donetcore3-spa-role-based-authorization-template/blob/main/Vue3DonetCore3SPATemplate/Vue3DonetCore3SPATemplate/ClientApp/src/components/SignIn.vue" target="_blank" rel="noopener noreferrer">參考這邊<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="getuserinfo">GetUserInfo</h2> <p>由於這次增加了 User Role，在拿取 User 的資料上，格式也進行了異動</p> <p>對應會更改到的是 <code>GetUserInfo</code> 這支API，以及 store 中儲存的格式</p> <h1 id="總結來說">總結來說</h1> <p>這邊透過 EF 建立了一個小小的會員認證、授權機制</p> <p>而由於 role 被存在了 DB，所以其實這些<code>設定</code>都是可以很動態的進行更改的</p> <p>只要建個後臺機制，這樣就可以讓擁有 Admin Role 的人直接使用網站來調整 User 的權限了</p> <p><a href="https://github.com/Jchou24/vue3-donetcore3-spa-role-based-authorization-template" target="_blank" rel="noopener noreferrer">完整的Code在此<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 歡迎參考看看啦</p> <hr class="footnotes-sep"> <section class="footnotes"><ol class="footnotes-list"><li id="fn1" class="footnote-item"><p><a href="https://docs.microsoft.com/zh-tw/aspnet/core/security/authorization/roles?view=aspnetcore-5.0" target="_blank" rel="noopener noreferrer">ASP.NET Core 中以角色為基礎的授權<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="#fnref1" class="footnote-backref">↩︎</a></p></li> <li id="fn2" class="footnote-item"><p><a href="https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/security/authorization/secure-data/samples/" target="_blank" rel="noopener noreferrer">Official Authorization Sample<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="#fnref2" class="footnote-backref">↩︎</a></p></li> <li id="fn3" class="footnote-item"><p><a href="https://www.codeproject.com/Articles/5165567/MVC-NET-Core-Dynamic-Role-Based-Authorization?fbclid=IwAR03z9zrGfCUiHOsbl86r6pRLO-_XcK9OCtGKSPiRhlAWPIsuhrOIoAbwL4" target="_blank" rel="noopener noreferrer">MVC .NET Core Dynamic Role Based Authorization<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="#fnref3" class="footnote-backref">↩︎</a></p></li> <li id="fn4" class="footnote-item"><p><a href="https://stackoverflow.com/questions/31464359/how-do-you-create-a-custom-authorizeattribute-in-asp-net-core" target="_blank" rel="noopener noreferrer">How do you create a custom AuthorizeAttribute in ASP.NET Core?<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="#fnref4" class="footnote-backref">↩︎</a></p></li> <li id="fn5" class="footnote-item"><p><a href="https://docs.microsoft.com/en-us/ef/core/get-started/overview/first-app?WT.mc_id=DOP-MVP-37580&amp;tabs=netcore-cli" target="_blank" rel="noopener noreferrer">Getting Started with EF Core<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="#fnref5" class="footnote-backref">↩︎</a></p></li> <li id="fn6" class="footnote-item"><p><a href="https://blog.darkthread.net/blog/category/ef" target="_blank" rel="noopener noreferrer">黑暗執行緒上對 EF core 的介紹整理<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="#fnref6" class="footnote-backref">↩︎</a></p></li> <li id="fn7" class="footnote-item"><p><a href="https://blog.johnwu.cc/article/ironman-day24-asp-net-core-entity-framework-core.html" target="_blank" rel="noopener noreferrer">[鐵人賽 Day24] ASP.NET Core 2 系列 - Entity Framework Core<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="#fnref7" class="footnote-backref">↩︎</a></p></li> <li id="fn8" class="footnote-item"><p><a href="https://docs.microsoft.com/en-us/ef/core/modeling/relationships?tabs=fluent-api%2Cfluent-api-simple-key%2Csimple-key" target="_blank" rel="noopener noreferrer">Relationships<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="#fnref8" class="footnote-backref">↩︎</a> <a href="#fnref8:1" class="footnote-backref">↩︎</a></p></li> <li id="fn9" class="footnote-item"><p><a href="https://stackoverflow.com/questions/4181198/how-to-hash-a-password" target="_blank" rel="noopener noreferrer">How to hash a password<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="#fnref9" class="footnote-backref">↩︎</a></p></li> <li id="fn10" class="footnote-item"><p><a href="https://blog.johnwu.cc/article/ironman-day04-asp-net-core-dependency-injection.html" target="_blank" rel="noopener noreferrer">[鐵人賽 Day04] ASP.NET Core 2 系列 - 依賴注入 (Dependency Injection)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="#fnref10" class="footnote-backref">↩︎</a></p></li></ol></section></div></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.c7870012.js" defer></script><script src="/assets/js/layout-Layout.29445450.js" defer></script><script src="/assets/js/page-7ba2451f.179b57eb.js" defer></script>
  </body>
</html>
